
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="../assets/img/white.png">
  <title>STEM STORE</title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Nucleo Icons -->
  <link href="../assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link href="../assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link id="pagestyle" href="../assets/css/argon-dashboard.css?v=2.0.4" rel="stylesheet" />
</head>

<body class="g-sidenav-show   bg-gray-100">
  <div class="min-height-300 bg-primary position-absolute w-100"></div>
  <aside class="sidenav bg-white navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-4" id="sidenav-main" style="height: 100vh; position: fixed; overflow: hidden;">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand m-0" href=" ../index2.php " target="_blank">
        <img src="../assets/img/logo-ct-dark.png" class="navbar-brand-img h-100" alt="main_logo">
        <span class="ms-1 font-weight-bold">STEM STORE</span>
      </a>
    </div>
   <hr class="horizontal dark mt-0 mb-2">
  <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main" style="height: calc(100vh - 100px); overflow-y: auto;">
  <ul class="navbar-nav">
    <li class="nav-item">
      <a class="nav-link " href="../index2.php">
        <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
          <i class="fas fa-tachometer-alt text-primary text-sm opacity-10"></i>
        </div>
        <span class="nav-link-text ms-1">Dashboard</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="sales.php">
        <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
          <i class="fas fa-hand-holding-usd text-warning text-sm opacity-10"></i>
        </div>
        <span class="nav-link-text ms-1">Return Products</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link " href="products.php">
        <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
          <i class="fas fa-boxes text-danger text-sm opacity-10"></i>
        </div>
        <span class="nav-link-text ms-1">Manage Products</span>
      </a>
    </li>
    
   <li class="nav-item">
      <a class="nav-link" href="addproducts.php">
        <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
          <i class="fas fa-plus-square text-success text-sm opacity-10"></i>
        </div>
        <span class="nav-link-text ms-1">Add Products</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="Manageadmin.php">
        <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
          <i class="fas fa-user-shield text-info text-sm opacity-10"></i>
        </div>
        <span class="nav-link-text ms-1">Manage Admin</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link " href="users.php">
        <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
          <i class="fas fa-users text-info text-sm opacity-10"></i>
        </div>
        <span class="nav-link-text ms-1">Manage Users</span>
      </a>
    </li>
        <li class="nav-item">
      <a class="nav-link" href="customers.php">
        <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
          <i class="fas fa-user-friends text-primary text-sm opacity-10"></i>
        </div>
        <span class="nav-link-text ms-1">Manage Store keepers</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="register.html">
        <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
          <i class="fas fa-user-plus text-success text-sm opacity-10"></i>
        </div>
        <span class="nav-link-text ms-1">Register</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="customer_report.php">
        <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
          <i class="fas fa-chart-bar text-primary text-sm opacity-10"></i>
        </div>
        <span class="nav-link-text ms-1">Users Report</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link active" href="report.php">
        <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
          <i class="fas fa-chart-line text-success text-sm opacity-10"></i>
        </div>
        <span class="nav-link-text ms-1">Reports</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="profile.php">
        <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
          <i class="fas fa-user text-dark text-sm opacity-10"></i>
        </div>
        <span class="nav-link-text ms-1">Profile</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="../pages/login.php">
        <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
          <i class="fas fa-sign-out-alt text-danger text-sm opacity-10"></i>
        </div>
        <span class="nav-link-text ms-1">Logout</span>
      </a>
    </li>
  </ul>
</div>
</aside>

  <main class="main-content position-relative border-radius-lg ">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl " id="navbarBlur" data-scroll="false">
      <div class="container-fluid py-1 px-3">
          <ul class="navbar-nav  justify-content-end">
            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line bg-white"></i>
                  <i class="sidenav-toggler-line bg-white"></i>
                  <i class="sidenav-toggler-line bg-white"></i>
                </div>
              </a>
            </li>
            <li class="nav-item dropdown pe-2 d-flex align-items-center">
              <ul class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4" aria-labelledby="dropdownMenuButton">
                <li>
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="avatar avatar-sm bg-gradient-secondary  me-3  my-auto">
                        <svg width="12px" height="12px" viewBox="0 0 43 36" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                          <title>credit-card</title>
                          <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g transform="translate(-2169.000000, -745.000000)" fill="#FFFFFF" fill-rule="nonzero">
                              <g transform="translate(1716.000000, 291.000000)">
                                <g transform="translate(453.000000, 454.000000)">
                                  <path class="color-background" d="M43,10.7482083 L43,3.58333333 C43,1.60354167 41.3964583,0 39.4166667,0 L3.58333333,0 C1.60354167,0 0,1.60354167 0,3.58333333 L0,10.7482083 L43,10.7482083 Z" opacity="0.593633743"></path>
                                  <path class="color-background" d="M0,16.125 L0,32.25 C0,34.2297917 1.60354167,35.8333333 3.58333333,35.8333333 L39.4166667,35.8333333 C41.3964583,35.8333333 43,34.2297917 43,32.25 L43,16.125 L0,16.125 Z M19.7083333,26.875 L7.16666667,26.875 L7.16666667,23.2916667 L19.7083333,23.2916667 L19.7083333,26.875 Z M35.8333333,26.875 L28.6666667,26.875 L28.6666667,23.2916667 L35.8333333,23.2916667 L35.8333333,26.875 Z"></path>
                                </g>
                              </g>
                            </g>
                          </g>
                        </svg>
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                      </div>
                    </div>
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- End Navbar -->
    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-lg-8">
          <div class="row">

            </div>
          </div>
        </div>

        <?php
include '../connection.php';

// Set timezone
date_default_timezone_set('Africa/Dar_es_Salaam');

// Function to fetch sales report data
function fetchSalesReport($conn, $period, $startDate = null, $endDate = null, $orderNo = null) {
    $whereClause = "WHERE o.Status = 'Approved' ";
    $params = [];
    $types = '';
    
    // Handle date range
    if ($period === 'custom' && $startDate && $endDate) {
        $whereClause .= "AND o.AddedDate BETWEEN ? AND ? ";
        $params[] = $startDate . ' 00:00:00';
        $params[] = $endDate . ' 23:59:59';
        $types .= 'ss';
    } else {
        $interval = match($period) {
            'Daily' => '1 DAY',
            'Weekly' => '1 WEEK',
            'Monthly' => '1 MONTH',
            'Annual' => '1 YEAR',
            default => '1 MONTH',
        };
        $whereClause .= "AND o.AddedDate >= NOW() - INTERVAL $interval ";
    }

    // Prepare the SQL statement
    $sql = "
        SELECT 
            o.ID AS OrderNo,
            o.UserID, 
            p.ProductName,  
            oi.Price AS ProductCost, 
            o.Status, 
            o.AddedDate as OrderDate,
            SUM(oi.Quantity) AS QuantitySold,
            SUM(oi.Price * oi.Quantity) AS TotalRevenue
        FROM orders o
        JOIN order_items oi ON o.ID = oi.OrderID
        JOIN products p ON oi.ProductID = p.ID  
        $whereClause
        GROUP BY p.ProductName, o.ID, o.UserID, o.Status, o.AddedDate
        ORDER BY TotalRevenue DESC;
    ";

    // Add search condition for Order No if provided
    if ($orderNo) {
        $sql = str_replace("$whereClause", "$whereClause AND o.ID = ?", $sql);
        $params[] = $orderNo;
        $types .= 'i';
    }

    // Prepare and execute the statement
    $stmt = $conn->prepare($sql);

    if (!empty($params)) {
        $stmt->bind_param($types, ...$params);
    }

    $stmt->execute();
    $result = $stmt->get_result();

    if ($result && $result->num_rows > 0) {
        return $result->fetch_all(MYSQLI_ASSOC);
    } else {
        return [];
    }
}

// Get report parameters from the URL
$period = $_GET['period'] ?? 'Monthly';
$startDate = $_GET['start_date'] ?? date('Y-m-d', strtotime('-30 days'));
$endDate = $_GET['end_date'] ?? date('Y-m-d');
$orderNo = $_GET['order_no'] ?? null;
$reportType = $_GET['report_type'] ?? 'sales'; // sales, inventory, returns, new_stock
$exportType = $_GET['export'] ?? null; // pdf, excel, csv

// Fetch data based on report type
$reportData = [];
$summaryData = [];

switch ($reportType) {
    case 'inventory':
        // Out of stock and low stock items
        $sql = "SELECT ID, ProductName, Quantity, prod_price as Price,
                       CASE 
                           WHEN Quantity = 0 THEN 'Out of Stock' 
                           WHEN Quantity <= 5 THEN 'Low Stock' 
                           ELSE 'In Stock' 
                       END as StockStatus
                FROM products 
                ORDER BY Quantity ASC, ProductName";
        $reportData = $conn->query($sql)->fetch_all(MYSQLI_ASSOC);
        break;
        
    case 'new_stock':
        // Recently added products (last 30 days)
        $sql = "SELECT ID, ProductName, Quantity, prod_price as Price, AddedDate 
                FROM products 
                WHERE AddedDate >= DATE_SUB(NOW(), INTERVAL 30 DAY)
                ORDER BY AddedDate DESC";
        $reportData = $conn->query($sql)->fetch_all(MYSQLI_ASSOC);
        break;
        
    case 'returns':
        // Returned products
        $sql = "SELECT r.ReturnID, o.ID as OrderID, p.ProductName, r.Quantity, r.Reason, r.ReturnDate, r.Status
                FROM returns r
                JOIN orders o ON r.OrderID = o.ID
                JOIN products p ON r.ProductID = p.ID
                ORDER BY r.ReturnDate DESC";
        $reportData = $conn->query($sql)->fetch_all(MYSQLI_ASSOC);
        break;
        
    case 'sales':
    default:
        // Sales report (default)
        $reportData = fetchSalesReport($conn, $period, $startDate, $endDate, $orderNo);
        
        // Calculate summary data
        $totalSales = 0;
        $productQuantities = [];
        $totalOrders = count(array_unique(array_column($reportData, 'OrderNo')));
        
        foreach ($reportData as $row) {
            $totalSales += $row['TotalRevenue'];
            if (!isset($productQuantities[$row['ProductName']])) {
                $productQuantities[$row['ProductName']] = 0;
            }
            $productQuantities[$row['ProductName']] += $row['QuantitySold'];
        }
        
        // Sort products by quantity in descending order and get top 3
        arsort($productQuantities);
        $topProducts = array_slice($productQuantities, 0, 3, true);
        
        $summaryData = [
            'total_sales' => $totalSales,
            'total_orders' => $totalOrders,
            'avg_order_value' => $totalOrders > 0 ? $totalSales / $totalOrders : 0,
            'top_products' => $topProducts
        ];
        break;
}

// Handle exports
if ($exportType) {
    switch ($exportType) {
        case 'pdf':
            // Use existing PDF export
            break;
            
        case 'excel':
        case 'csv':
            $filename = $reportType . '_report_' . date('Y-m-d') . ($exportType === 'excel' ? '.xlsx' : '.csv');
            $delimiter = $exportType === 'excel' ? "\t" : ",";
            
            header('Content-Type: text/' . ($exportType === 'excel' ? 'vnd.ms-excel' : 'csv'));
            header('Content-Disposition: attachment; filename="' . $filename . '"');
            
            $output = fopen('php://output', 'w');
            
            // Output headers
            if (!empty($reportData)) {
                fputcsv($output, array_keys($reportData[0]), $delimiter);
                
                // Output data
                foreach ($reportData as $row) {
                    fputcsv($output, $row, $delimiter);
                }
            }
            
            fclose($output);
            exit();
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title><?php echo ucfirst($reportType); ?> Report - <?php echo htmlspecialchars($period); ?></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        .report-box {
            max-width: 800px;
            margin: auto;
            padding: 30px;
            border: 1px solid #eee;
            font-size: 16px;
            color: #555;
        }
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            line-height: inherit;
            text-align: left;
            border-collapse: collapse;
        }
        table th, table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .total {
            font-weight: bold;
        }
        .most-sold {
            background-color: #eee;
            padding: 10px;
            font-weight: bold;
        }
        .btn-download {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            margin: 10px 0;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
        }
        .btn-download:hover {
            background-color: #45a049;
        }
        .medium-input {
            width: 50%;
            padding: 5px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="h4 mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        <?php echo ucfirst($reportType); ?> Report
                    </h2>
                    <div>
                        <a href="?report_type=<?php echo $reportType; ?>&export=pdf" class="btn btn-sm btn-light me-2">
                            <i class="fas fa-file-pdf me-1"></i> PDF
                        </a>
                        <a href="?report_type=<?php echo $reportType; ?>&export=excel" class="btn btn-sm btn-light me-2">
                            <i class="fas fa-file-excel me-1"></i> Excel
                        </a>
                        <a href="?report_type=<?php echo $reportType; ?>&export=csv" class="btn btn-sm btn-light">
                            <i class="fas fa-file-csv me-1"></i> CSV
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Report Filters -->
                <form method="GET" action="" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Report Type</label>
                            <select name="report_type" class="form-select" onchange="this.form.submit()">
                                <option value="sales" <?php echo $reportType === 'sales' ? 'selected' : ''; ?>>Sales Report</option>
                                <option value="inventory" <?php echo $reportType === 'inventory' ? 'selected' : ''; ?>>Inventory Status</option>
                                <option value="new_stock" <?php echo $reportType === 'new_stock' ? 'selected' : ''; ?>>New Stock</option>
                                <option value="returns" <?php echo $reportType === 'returns' ? 'selected' : ''; ?>>Returns</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label class="form-label">Time Period</label>
                            <select name="period" class="form-select" id="periodSelect">
                                <option value="Daily" <?php echo $period === 'Daily' ? 'selected' : ''; ?>>Today</option>
                                <option value="Weekly" <?php echo $period === 'Weekly' ? 'selected' : ''; ?>>This Week</option>
                                <option value="Monthly" <?php echo $period === 'Monthly' ? 'selected' : ''; ?>>This Month</option>
                                <option value="Annual" <?php echo $period === 'Annual' ? 'selected' : ''; ?>>This Year</option>
                                <option value="custom" <?php echo $period === 'custom' ? 'selected' : ''; ?>>Custom Range</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6" id="dateRangeContainer" style="display: <?php echo $period === 'custom' ? 'block' : 'none'; ?>">
                            <div class="row">
                                <div class="col">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" name="start_date" class="form-control" value="<?php echo $startDate; ?>">
                                </div>
                                <div class="col">
                                    <label class="form-label">End Date</label>
                                    <input type="date" name="end_date" class="form-control" value="<?php echo $endDate; ?>">
                                </div>
                            </div>
                        </div>
                        
                        <?php if ($reportType === 'sales'): ?>
                        <div class="col-md-3">
                            <label class="form-label">Order Number</label>
                            <input type="text" name="order_no" class="form-control" placeholder="Search by Order No" value="<?php echo htmlspecialchars($orderNo); ?>">
                        </div>
                        <?php endif; ?>
                        
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-filter me-1"></i> Apply Filters
                            </button>
                            <a href="?report_type=<?php echo $reportType; ?>" class="btn btn-outline-secondary">
                                <i class="fas fa-sync-alt me-1"></i> Reset
                            </a>
                        </div>
                    </div>
                </form>
                
                <!-- Report Summary Cards -->
                <?php if ($reportType === 'sales' && !empty($summaryData)): ?>
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Total Sales</h6>
                                <h3 class="mb-0">TZS <?php echo number_format($summaryData['total_sales'], 2); ?></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Total Orders</h6>
                                <h3 class="mb-0"><?php echo $summaryData['total_orders']; ?></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-info text-white mb-3">
                            <div class="card-body">
                                <h6 class="card-title mb-3">Top 3 Most Ordered Products</h6>
                                <div class="row">
                                    <?php 
                                    $i = 1;
                                    foreach ($summaryData['top_products'] as $product => $quantity): 
                                    ?>
                                    <div class="col-md-4">
                                        <div class="bg-white bg-opacity-25 p-2 rounded text-center">
                                            <div class="fw-bold">#<?php echo $i++; ?></div>
                                            <div class="small"><?php echo htmlspecialchars($product); ?></div>
                                            <div class="fw-bold mt-1"><?php echo $quantity; ?> units</div>
                                        </div>
                                    </div>
                                    <?php endforeach; ?>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <?php endif; ?>
                
                <!-- Report Content -->
                <div class="table-responsive">
                    <?php if ($reportType === 'sales'): ?>
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Order No</th>
                                <th>Date</th>
                                <th>Product</th>
                                <th class="text-end">Qty</th>
                                <th class="text-end">Price (TZS)</th>
                                <th class="text-end">Total (TZS)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if (empty($reportData)): ?>
                            <tr>
                                <td colspan="7" class="text-center py-4">No sales data found for the selected period.</td>
                            </tr>
                            <?php else: ?>
                                <?php foreach ($reportData as $data): ?>
                                <tr>
                                    <td>#<?php echo htmlspecialchars($data['OrderNo']); ?></td>
                                    <td><?php 
                                        $dateField = $data['OrderDate'] ?? ($data['AddedDate'] ?? null);
                                        echo $dateField ? date('M d, Y', strtotime($dateField)) : 'N/A'; 
                                    ?></td>
                                    <td><?php echo htmlspecialchars($data['ProductName']); ?></td>
                                    <td class="text-end"><?php echo number_format($data['QuantitySold']); ?></td>
                                    <td class="text-end"><?php echo number_format($data['ProductCost'], 2); ?></td>
                                    <td class="text-end fw-bold"><?php echo number_format($data['TotalRevenue'], 2); ?></td>
                                    <td>
                                        <span class="badge bg-<?php 
                                            echo match($data['Status']) {
                                                'Approved' => 'success',
                                                'Pending' => 'warning',
                                                'Cancelled' => 'danger',
                                                default => 'secondary'
                                            };
                                        ?>">
                                            <?php echo htmlspecialchars($data['Status']); ?>
                                        </span>
                                    </td>
                                </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </tbody>
                    </table>
                    
                    <?php elseif ($reportType === 'inventory'): ?>
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Product Name</th>
                                <th class="text-end">In Stock</th>
                                <th class="text-end">Price (TZS)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if (empty($reportData)): ?>
                            <tr>
                                <td colspan="5" class="text-center py-4">No inventory data found.</td>
                            </tr>
                            <?php else: ?>
                                <?php foreach ($reportData as $item): ?>
                                <tr>
                                    <td>#<?php echo $item['ID']; ?></td>
                                    <td><?php echo htmlspecialchars($item['ProductName']); ?></td>
                                    <td class="text-end"><?php echo number_format($item['Quantity']); ?></td>
                                    <td class="text-end"><?php echo number_format($item['Price'], 2); ?></td>
                                    <td>
                                        <span class="badge bg-<?php 
                                            echo match($item['StockStatus']) {
                                                'Out of Stock' => 'danger',
                                                'Low Stock' => 'warning',
                                                default => 'success'
                                            };
                                        ?>">
                                            <?php echo $item['StockStatus']; ?>
                                        </span>
                                    </td>
                                </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </tbody>
                    </table>
                    
                    <?php elseif ($reportType === 'new_stock'): ?>
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Product Name</th>
                                <th class="text-end">Quantity</th>
                                <th class="text-end">Price (TZS)</th>
                                <th>Date Added</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if (empty($reportData)): ?>
                            <tr>
                                <td colspan="5" class="text-center py-4">No new stock added recently.</td>
                            </tr>
                            <?php else: ?>
                                <?php foreach ($reportData as $item): ?>
                                <tr>
                                    <td>#<?php echo $item['ID']; ?></td>
                                    <td><?php echo htmlspecialchars($item['ProductName']); ?></td>
                                    <td class="text-end"><?php echo number_format($item['Quantity']); ?></td>
                                    <td class="text-end"><?php echo number_format($item['Price'], 2); ?></td>
                                    <td><?php echo !empty($item['AddedDate']) ? date('M d, Y', strtotime($item['AddedDate'])) : 'N/A'; ?></td>
                                </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </tbody>
                    </table>
                    
                    <?php elseif ($reportType === 'returns'): ?>
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Return ID</th>
                                <th>Order #</th>
                                <th>Product</th>
                                <th class="text-end">Qty</th>
                                <th>Reason</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php if (empty($reportData)): ?>
                            <tr>
                                <td colspan="7" class="text-center py-4">No return records found.</td>
                            </tr>
                            <?php else: ?>
                                <?php foreach ($reportData as $return): ?>
                                <tr>
                                    <td>#<?php echo $return['ReturnID']; ?></td>
                                    <td>#<?php echo $return['OrderID']; ?></td>
                                    <td><?php echo htmlspecialchars($return['ProductName']); ?></td>
                                    <td class="text-end"><?php echo $return['Quantity']; ?></td>
                                    <td><?php echo htmlspecialchars($return['Reason']); ?></td>
                                    <td><?php echo !empty($return['ReturnDate']) ? date('M d, Y', strtotime($return['ReturnDate'])) : 'N/A'; ?></td>
                                    <td>
                                        <span class="badge bg-<?php 
                                            echo match($return['Status']) {
                                                'Processed' => 'success',
                                                'Pending' => 'warning',
                                                'Rejected' => 'danger',
                                                default => 'secondary'
                                            };
                                        ?>">
                                            <?php echo $return['Status']; ?>
                                        </span>
                                    </td>
                                </tr>
                                <?php endforeach; ?>
                            <?php endif; ?>
                        </tbody>
                    </table>
                    <?php endif; ?>
                </div>
            </div>
            
            <div class="card-footer text-muted">
                <small>Report generated on <?php echo date('F j, Y, g:i a'); ?></small>
                <div class="float-end">
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="window.print()">
                        <i class="fas fa-print me-1"></i> Print
                    </button>
                    <a href="?report_type=<?php echo $reportType; ?>&export=pdf" class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-file-pdf me-1"></i> Save as PDF
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Toggle date range fields based on period selection
        document.getElementById('periodSelect').addEventListener('change', function() {
            const dateRangeContainer = document.getElementById('dateRangeContainer');
            dateRangeContainer.style.display = this.value === 'custom' ? 'block' : 'none';
        });
        
        // Initialize Select2 for better dropdowns
        $(document).ready(function() {
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%'
            });
        });
        
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    </script>
</body>
</html>

<?php
// Close database connection
$conn->close();
?>

          </div>
        </div>
      </div>
      <!-- <footer class="footer pt-3  ">
        <div class="container-fluid">
          <div class="row align-items-center justify-content-lg-between">
            <div class="col-lg-6 mb-lg-0 mb-4">
              <div class="copyright text-center text-sm text-muted text-lg-start">
                Â© <script>
                  document.write(new Date().getFullYear())
                </script> <i class="fa fa-heart"></i>
                <a href="" class="font-weight-bold" target="_blank"></a>
              </div>
            </div>
          </div>
        </div>
      </footer> -->
    </div>
  </main>
   <!--   Core JS Files   -->
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
  <script>
    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }
  </script>
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="../assets/js/argon-dashboard.min.js?v=2.0.4"></script>
</body>

</html>